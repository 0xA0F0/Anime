<!DOCTYPE html>
<html lang="ru">
	<head>
		<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Найди свое аниме для просмотра!">
    <meta name="keywords" content="anime, аниме, аниме просмотр, watch anime ">
    <meta name="author" content="Pirate">
		<title>Поиск аниме для просмотра</title>
    <link rel="shortcut icon" href="img/favicon.ico" type="image/x-icon">
		<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
		<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
		<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-database-compat.js"></script>
		<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet">
		<link rel="stylesheet" href="styles.css">
		<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
	</head>
	<body>
    <click-spark></click-spark>
		<div id="app">
			<button v-if="isVisible" @click="scrollToTop" class="go-to-top material-symbols-outlined"> arrow_upward </button>
			<div v-if="showFAQModal" class="modal-overlay" @click.self="closeFAQModal">
				<div class="modal-content">
					<span class="modal-close" @click="closeFAQModal">&times;</span>
					<h2>Часто задаваемые вопросы (FAQ)</h2>
					<div class="faq-text">
						<b>Что за список?</b>
						<p>Это JSON файл твоего аниме списка.</p>
						<p>
							<b>Где его достать? </b>
						</p>
						<p>На сайте Шикимори.</p>
						<p>
							<b>Как?</b>
						</p>
						<b style="color: var(--loader);"> Залогинься на шикимори </b>
						<span style="color:var(--revert)">></span>
						<b style="color: var(--loader);">Настройки</b>
						<span style="color:var(--revert)">></span>
						<b style="color: var(--loader);">Список аниме и манги</b>
						<span style="color:var(--revert)">></span>
						<b style="color: var(--loader);">Экспортировать список</b>
						<span style="color:var(--revert)">></span>
						<b style="color: var(--loader);">Экспорт аниме</b>
						<span style="color:var(--revert)">></span>
						<b style="color: var(--loader);">JSON</b>
						<br>
						<br> Затем нажми на кнопку: <b style="color:var(--status-border-green)">Загрузить аниме список</b> и вуаля. <br>
						<br>
						<hr>
						<p>
							<b>Что означает? <span class="material-symbols-outlined">done_all</span>
							</b>
						</p>
						<p>Статус аниме: Вышло.</p>
						<br>
						<br>
						<p>
							<b>Что означает? <span class="material-symbols-outlined">check</span>
							</b>
						</p>
						<p>Это означает что ты посмотрел аниме. </p>
						<br>
						<br>
						<p>
							<b>Что означает? <span class="material-symbols-outlined">progress_activity</span>
							</b>
						</p>
						<p>Статус аниме: Онгоинг. </p>
						<br>
						<br>
						<p>
							<b>Что означает? <span class="material-symbols-outlined">play_circle</span>
							</b>
						</p>
						<p>Это означает что ты смотришь аниме. </p>
					</div>
				</div>
			</div>
			<div class="page">
				<div v-if="message" :class="['message', messageClass]">
					<span class="material-symbols-outlined">
						{{ messageClass === 'error' ? 'error' : 'check_circle' }}
					</span>
					{{ message }}
				</div>
				<div class="menu">
					<button v-if="(route === '#login' || route === '#forgot' || route === '#reg') && !user" @click.prevent="homePage(true)" class="exept">
						<span class="material-symbols-outlined">arrow_back</span>
					</button>
					<button @click="toggleTheme">
						<span class="material-symbols-outlined">
							{{ isDarkMode ? 'sunny' : 'dark_mode' }}
						</span>
					</button>
					<button v-if="user" @click="deleteAccount" class="btn btn-danger">
						<span class="material-symbols-outlined">delete</span>
						<span class="xol">Удалить аккаунт</span>
					</button>
					<button v-if="user" @click="triggerFileUpload">
						<span class="material-symbols-outlined">upload_file</span>
						<span class="xol">Загрузить аниме список</span>
					</button>
					<button v-if="user" @click="openFAQModal" class="faq-button">
						<span class=" material-symbols-outlined">help</span>
						<span class="xol">FAQ</span>
					</button>
					<input v-if="user" ref="fileInput" type="file" @change="handleJsonChange" accept=".json" style="display: none;" />
					<button v-if="!user && !isAuthRoute" @click="navigateTo('#login')">
						<span class="material-symbols-outlined">login</span>
					</button>
					<button v-if="!user && !isAuthRoute" @click="navigateTo('#reg')">
						<span class="material-symbols-outlined">person_add</span>
					</button>
					<button v-if="user" @click="logout">
						<span class="material-symbols-outlined">logout</span>
						<span class="xol">Выйти</span>
					</button>
				</div>
				<div v-if="user" class="profil">
					<div>
						<div class="items">
							<b class="nickname">{{ user.displayName }}</b>
							<a :href="user.photoURL" target="_blank" class="avalink">
								<img :src="user.photoURL" alt="Аватарка" v-if="user.photoURL" class="avatar" />
							</a>
						</div>
						<div class="list">
							<div class="fp">
								<div @click="openAnimeList('watching')">
									<span class="material-symbols-outlined">play_circle</span> Просматриваемых: {{ watchingCount }}
								</div>
								<div @click="openAnimeList('planned')">
									<span class="material-symbols-outlined">today</span> Планируемых: {{ plannedCount }}
								</div>
								<div @click="openAnimeList('completed')">
									<span class="material-symbols-outlined">check</span> Просмотренных: {{ completedCount }}
								</div>
							</div>
							<div class="fp">
								<div @click="openAnimeList('on_hold')">
									<span class="material-symbols-outlined">inbox</span> Отложенных: {{ onHoldCount }}
								</div>
								<div @click="openAnimeList('dropped')">
									<span class="material-symbols-outlined">delete</span> Брошенных: {{ droppedCount }}
								</div>
								<div @click="openAnimeList('')">
									<span class="material-symbols-outlined">list</span> Всего аниме: {{ totalAnimes }}
								</div>
							</div>
						</div>
					</div>
				</div>
				<div v-else>
					<div v-if="route === '#login'" class="access" v-if="(route === '#login' || route === '#forgot' || route === '#reg') && !user">
						<form class="form" @submit.prevent="login">
							<input style="width:100%" v-model="email" type="email" placeholder="Email" required />
							<div class="y">
								<input style="width: 100%;" v-model="password" :type="showPassword ? 'text' : 'password'" placeholder="Пароль" required />
								<span @click="switchIcon" class="xx material-symbols-outlined">{{ showPassword ? 'visibility' : 'visibility_off' }}</span>
							</div>
							<button type="submit">Войти</button>
							<button @click.prevent="forgotPage(true)" class="exept"> Забыл пароль? </button>
							<button @click.prevent="regPage(true)" class="exept"> Зарегистрироваться </button>
						</form>
					</div>
					<div v-else-if="route === '#reg'" class="access" v-if="(route === '#login' || route === '#forgot' || route === '#reg') && !user">
						<form class="form" @submit.prevent="register">
							<div class="avatar-upload" @dragover.prevent="onDragOver" @dragleave.prevent="onDragLeave" @drop.prevent="onDrop" :class="{ 'drag-over': isDragOver }">
								<label for="avatar" v-if="!avatarPreview"></label>
								<input type="file" id="avatar" accept="image/*" @change="onAvatarChange" />
								<div v-if="!avatarPreview" class="avatar-instruction">
									<img src="https://placehold.co/90x90?text=%D0%BF%D0%B5%D1%80%D0%B5%D1%82%D0%B0%D1%89%D0%B8\n%D0%B8%D0%BB%D0%B8\n%D0%BA%D0%BB%D0%B8%D0%BA%D0%BD%D0%B8" alt="Инструкция загрузки аватара" class="instruction-image" />
								</div>
								<div v-if="avatarPreview" class="avatar-preview">
									<img :src="avatarPreview" alt="Avatar Preview" />
								</div>
							</div>
							<input style="width:100%" v-model="nickname" type="text" placeholder="Никнейм" required />
							<input style="width:100%" v-model="email" type="email" placeholder="Email" required />
							<div class="y">
								<input style="width:100%" v-model="password" :type="showPassword ? 'text' : 'password'" placeholder="Пароль" required />
								<span @click="switchIcon" class="xx material-symbols-outlined">
									{{ showPassword ? 'visibility' : 'visibility_off' }}
								</span>
							</div>
							<button type="submit">Зарегистрироваться</button>
							<button @click.prevent="logPage(true)" class="exept"> Вернуться к входу? </button>
						</form>
					</div>
				</div>
				<div v-if="!isAuthRoute && (route !== '#login' && route !== '#reg' && route !== '#forgot') && isSearchVisible" style="display: flex; flex-direction: column; gap: 5px; position: relative;">
					<span class="material-symbols-outlined" style="position: absolute; right: 10px; top: 8px;">search</span>
					<input type="text" v-model="searchQuery" @input="debouncedSearch" class="search-input" placeholder="Введи название аниме" />
					<div v-if="isLoading" class="loading-indicator" role="alert" aria-live="assertive" style="border-width: 2px;border-style: solid;border-color: var(--loader-0) var(--loader-0) var(--loader-0) var(--loader);border-image: initial;width: 20px;height: 20px;border-radius: 50%;animation: 1s linear 0s infinite normal none running spin;margin: 10px auto auto auto;"></div>
					<div v-else-if="searchQuery && !animes.length && !isLoading" style=" display: flex; align-self: center; margin-top: 10px; opacity: .4; ">
						<span class="material-symbols-outlined" style="font-size: 2em !important;"> breaking_news_alt_1 </span>
					</div>
					<div id="animes" style="display: flex; flex-direction: column; gap: 5px; margin-top: 10px;">
						<div v-for="anime in animes" :key="anime.id" class="anime" @click="selectAnime(anime.id)" style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
							<img :src="anime.poster.previewUrl" alt="Poster" style="width: 50px; height: 70px; object-fit: cover;" />
							<span class="name" style="flex-grow: 1;">{{ anime.russian || anime.name }}</span>
							<span class="status">
								<span class="material-symbols-outlined">
									{{ anime.status === 'released' ? 'done_all' : anime.status === 'ongoing' ? 'progress_activity' : '' }}
								</span>
							</span>
							</span>
							<span v-if="anime.userStatus" class="anime-status" style="display: flex; align-items: center;">
								<span class="material-symbols-outlined">
									{{ getStatusIcon(anime.userStatus) }}
								</span>
							</span>
						</div>
					</div>
				</div>
			</div>
		</div>
		</div>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
		<script src="firebaseConfig.js" type="module"></script>
		<script src="auth.js" type="module"></script>
		<script src="animeSearch.js" type="module"></script>
		<script src="main.js" type="module"></script>
	</body>
</html>